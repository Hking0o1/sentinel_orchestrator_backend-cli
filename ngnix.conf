# Use a lightweight, official NGINX image based on Alpine Linux.
# Alpine images are small and have a minimal attack surface.
FROM nginx:1.27-alpine

# Remove the default NGINX configuration file.
RUN rm /etc/nginx/conf.d/default.conf

# Copy our custom, hardened 'nginx.conf' file from the local 'proxy' directory
# into the container's configuration directory.
# This file will contain all our security headers, rate limiting, and
# reverse proxy logic.
COPY nginx.conf /etc/nginx/conf.d/

# 1. Upstream Server Definition
# Defines a "pool" of backend servers. We only have one,
# but this makes it easy to add more for load balancing later.
upstream backend_api {
    # 'backend' is the hostname of our FastAPI container on the
    # internal Docker network (defined in docker-compose.yml).
    # '8000' is the port uvicorn runs on inside that container.
    server backend:8000;
}

# 2. Global Rate Limiting
# Creates a 10MB shared memory zone to track IP addresses.
# This rule allows an average of 10 requests/second from a single IP,
# with a burst of 20. This is our first line of defense against DoS.
limit_req_zone $binary_remote_addr zone=api_burst:10m rate=10r/s;


# 3. Main Server Block
server {
    # NGINX will listen on port 80 (standard HTTP) inside the container.
    # The docker-compose file maps port 80 on the host to this port.
    listen 80;
    server_name localhost; # Responds to requests for 'localhost'

    # Set a larger buffer size for file uploads or large API requests
    client_max_body_size 10M;

    # 4. Security Headers (Frontend Hardening)
    # These headers are sent with *every* response to instruct the
    # user's browser on how to behave securely.

    # Content Security Policy (CSP) - The most important one.
    # Disallows loading any content (scripts, styles) not from our own domain.
    # 'self' = our domain
    # 'unsafe-inline' is needed for many modern JS frameworks.
    # For higher security, this would be replaced with a 'nonce'.
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self'; object-src 'none'; frame-ancestors 'none';" always;

    # X-Frame-Options - Prevents Clickjacking
    # 'DENY' = Do not allow our site to be loaded in an <iframe> anywhere.
    add_header X-Frame-Options "DENY" always;

    # X-Content-Type-Options - Prevents MIME-sniffing
    # Forces the browser to trust the 'Content-Type' header we send.
    add_header X-Content-Type-Options "nosniff" always;

    # HTTP Strict Transport Security (HSTS)
    # Tells the browser to *only* use HTTPS for all future requests.
    # (Note: This is commented out because we are using HTTP for localhost.
    # You MUST uncomment this when you deploy with a real SSL certificate.)
    # add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Referrer-Policy - Controls how much information is sent
    # when navigating away from our site. 'strict-origin-when-cross-origin'
    # is a modern, secure default.
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # Permissions-Policy - Disables browser features we don't need
    # (e.g., microphone, camera, geolocation)
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;

    # 5. Main Location Block (Proxy Logic)
    # This block handles all incoming requests.
    location / {
        # Apply the rate limiting rule we defined earlier.
        # 'nodelay' = Immediately reject requests over the burst limit.
        limit_req zone=api_burst nodelay;

        # These headers are crucial for the backend API.
        # They pass the *original* host and IP address from the user
        # to our FastAPI application, which is hidden behind the proxy.
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # The magic! Pass the request to our upstream 'backend_api' pool.
        proxy_pass http://backend_api;

        # Increase timeouts for long-running API requests
        proxy_connect_timeout 60s;
        proxy_send_timeout    60s;
        proxy_read_timeout    60s;
    }

    # 6. Static Content (Future Use)
    # If we had a frontend, we'd add a block like this to serve
    # HTML/CSS/JS files directly from NGINX, which is very fast.
    location /static/ {
        alias /var/www/static/;
    }
}
